<script type="module">
  // Importamos las herramientas de Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- CONFIGURACIÓN DE FIREBASE ---
  // IMPORTANTE: Reemplaza estos datos con los de tu consola de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDK_yslhuhATl4vcdA_oI2L8RTvUtp1k-4", 
    authDomain: "casino-2025-5d98f.firebaseapp.com",
    projectId: "casino-2025-5d98f",
    storageBucket: "casino-2025-5d98f.firebasestorage.app",
    messagingSenderId: "945932847322",
    appId: "1:945932847322:web:b6935ec8a4195e7445bde3"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Generar o recuperar un ID de usuario único
  let userId = localStorage.getItem('casino_user_id');
  if (!userId) {
      userId = "user_" + Math.random().toString(36).substring(7);
      localStorage.setItem('casino_user_id', userId);
  }

  // Variable de saldo local
  let balance = 0;

  // --- VINCULAR FUNCIONES AL WINDOW ---
  // Esto permite que el HTML vea las funciones dentro del módulo
  window.changeView = (id) => {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
  };

  // --- LÓGICA DE FIREBASE ---

  // Escuchar saldo en tiempo real
  const userDocRef = doc(db, "usuarios", userId);

  onSnapshot(userDocRef, (snap) => {
      if (snap.exists()) {
          balance = snap.data().saldo;
          document.getElementById('balance').textContent = balance.toLocaleString('en-US', { minimumFractionDigits: 2 });
      } else {
          // Si el usuario no existe en la nube, lo creamos con 500 iniciales
          setDoc(userDocRef, { 
              saldo: 500.00, 
              fechaCreacion: new Date().toLocaleString() 
          });
      }
  });

  // Función para jugar Slots
  window.playSlots = async () => {
      const betInput = document.getElementById('bet-slots');
      const bet = parseFloat(betInput.value);

      if (bet > balance || bet <= 0) {
          alert("Saldo insuficiente o apuesta no válida");
          return;
      }

      // Restar apuesta en Firebase
      const nuevoSaldoTrasApuesta = balance - bet;
      await updateDoc(userDocRef, { saldo: nuevoSaldoTrasApuesta });

      // Probabilidad 2 de 10
      setTimeout(async () => {
          if (Math.random() < 0.20) {
              const premio = bet * 5;
              await updateDoc(userDocRef, { saldo: nuevoSaldoTrasApuesta + premio });
              
              // Llamar a tu función de efectos visuales
              if (typeof window.showWinEffect === "function") {
                  window.showWinEffect(premio);
              } else {
                  alert("¡GANASTE Q" + premio + "!");
              }
          } else {
              document.getElementById('status').textContent = "Suerte para la próxima";
          }
      }, 500);
  };

  // Función para Canje
  window.redeem = async (cost, realAmount) => {
      if (balance >= cost) {
          if (confirm(`¿Canjear Q${cost} créditos por Q${realAmount} reales?`)) {
              // 1. Descontar saldo
              await updateDoc(userDocRef, { saldo: balance - cost });

              // 2. Registrar canje para el administrador
              await addDoc(collection(db, "canjes"), {
                  usuarioId: userId,
                  montoReal: realAmount,
                  costoCreditos: cost,
                  fecha: new Date().toLocaleString(),
                  status: "Pendiente"
              });

              alert("✅ Solicitud enviada. El admin revisará tu canje.");
          }
      } else {
          alert("No tienes suficientes créditos.");
      }
  };

</script>
